// Google Apps Script Code (Expense + CRM Version) - Refactored (Dynamic Columns + Supplier Lookup)

function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('Expense Manager')
      .addItem('Refresh Master Sheet', 'rebuildExpensesMaster')
      .addToUi();
}

function doGet(e) {
  var type = e.parameter.type || 'expense';
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  
  var sheetName;
  if (type == 'supplier') {
    sheetName = 'Suppliers';
  } else if (type == 'customer') {
    sheetName = 'Customers';
  } else if (type == 'income') {
    sheetName = 'All_Incomes_Master';
  } else if (type == 'lead') {
    sheetName = 'Leads';
  } else {
    sheetName = 'All_Expenses_Master';
  }

  var sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify([]))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  var data = sheet.getDataRange().getValues();
  if (data.length <= 1) {
     return ContentService.createTextOutput(JSON.stringify([]))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  // Headers (Hebrew default)
  var headers = data[0]; 
  var rows = data.slice(1);
  
  // Key Translation Map (Hebrew to English)
  var keyMap = {
    // Shared
    'מזהה': 'id',
    'סכום': 'amount',
    'תאריך': 'date',
    'קטגוריה': 'category',
    'הערות': 'notes',
    'מספר_חשבונית': 'invoiceNumber',
    'שם': 'name',
    'טלפון': 'phone',
    'אימייל': 'email',

    // Expenses
    'מזהה_ספק': 'supplierId',
    'שם_ספק': 'supplierName',
    'נוצר_בתאריך': 'createdAt', // Added mapping
    
    // Incomes
    'מזהה_לקוח': 'customerId',
    'שם_לקוח': 'customerName',
    
    // Leads
    'סטטוס': 'status',
    'שווי': 'value'
  };

  var result = rows.map(function(row) {
    var obj = {};
    headers.forEach(function(header, i) {
      var key = keyMap[header] || header; 
      var value = row[i];
      // FIX: Force Date to YYYY-MM-DD string to avoid timezone shifts in JSON.stringify
      if (value instanceof Date) {
        var y = value.getFullYear();
        var m = ('0' + (value.getMonth() + 1)).slice(-2);
        var d = ('0' + value.getDate()).slice(-2);
        obj[key] = y + '-' + m + '-' + d;
      } else {
        obj[key] = value;
      }
    });
    return obj;
  });
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var params = JSON.parse(e.postData.contents);
  var type = params.type;
  
  if (type == 'supplier') {
    var sheet = ss.getSheetByName("Suppliers");
    if (!sheet) {
      sheet = ss.insertSheet("Suppliers");
      sheet.appendRow(["מזהה", "שם"]);
    }
    sheet.appendRow([params.id, params.name]);
    
  } else if (type == 'customer') {
    var sheet = ss.getSheetByName("Customers");
    if (!sheet) {
      sheet = ss.insertSheet("Customers");
      sheet.appendRow(["מזהה", "שם", "טלפון", "אימייל"]);
    }
    sheet.appendRow([params.id, params.name, params.phone, params.email]);

  } else if (type == 'lead') {
    var sheet = ss.getSheetByName("Leads");
    if (!sheet) {
      sheet = ss.insertSheet("Leads");
      sheet.appendRow(["מזהה", "שם", "טלפון", "אימייל", "סטטוס", "שווי", "הערות", "נוצר_בתאריך"]);
    }
    sheet.appendRow([
      params.id, params.name, params.phone, params.email,
      params.status, params.value, params.notes, params.dateCreated
    ]);

  } else if (type == 'income') {
    var masterSheet = ss.getSheetByName("All_Incomes_Master");
    if (!masterSheet) {
      masterSheet = ss.insertSheet("All_Incomes_Master");
      masterSheet.appendRow(["מזהה", "סכום", "תאריך", "מזהה_לקוח", "שם_לקוח", "קטגוריה", "הערות", "מספר_חשבונית"]);
    }
    masterSheet.appendRow([
      params.id, params.amount, params.date, params.customerId, params.customerName || "Unknown",
      params.category, params.notes, params.invoiceNumber
    ]);

    // Write to Specific Customer Sheet
    var customerName = params.customerName || "Misc_Income";
    var safeName = "Inc_" + customerName.replace(/[:\/\\?*\[\]]/g, "_");
    
    var customerSheet = ss.getSheetByName(safeName); 
    if (!customerSheet) {
      customerSheet = ss.insertSheet(safeName);
      customerSheet.appendRow(["מזהה", "סכום", "תאריך", "קטגוריה", "הערות", "מספר_חשבונית", "סוג"]);
    }
    
    customerSheet.appendRow([
      params.id, params.amount, params.date, params.category, params.notes, params.invoiceNumber, "הכנסה"
    ]);

  } else {
    // Expense Handling (UPDATED)
    
    // 1. Write to Supplier Sheet ONLY
    var supplierName = params.supplierName || "Misc";
    var safeName = supplierName.replace(/[:\/\\?*\[\]]/g, "_");
    var supplierSheet = ss.getSheetByName(safeName);
    
    // Add Timestamp
    var timestamp = new Date(); 
    
    if (!supplierSheet) {
      supplierSheet = ss.insertSheet(safeName);
      supplierSheet.appendRow(["מזהה", "סכום", "תאריך", "קטגוריה", "הערות", "מספר_חשבונית", "סוג", "נוצר_בתאריך"]);
    }
    
    supplierSheet.appendRow([
      params.id, params.amount, params.date, params.category, params.notes, params.invoiceNumber, "הוצאה", timestamp
    ]);
    
    // 2. Rebuild the Master Sheet to ensure it's in sync
    rebuildExpensesMaster();
  }
  
  return ContentService.createTextOutput(JSON.stringify({"status": "success"}));
}

function rebuildExpensesMaster() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var masterSheet = ss.getSheetByName("All_Expenses_Master");
  
  if (!masterSheet) {
    masterSheet = ss.insertSheet("All_Expenses_Master");
  }
  
  // Clear existing content
  masterSheet.clear();
  
  // Set Headers for Master Sheet
  masterSheet.appendRow(["מזהה", "סכום", "תאריך", "מזהה_ספק", "שם_ספק", "קטגוריה", "הערות", "מספר_חשבונית", "נוצר_בתאריך"]);
  
  var sheets = ss.getSheets();
  var allExpenses = [];
  
  // --- Step 1: Build Supplier Lookup Map ---
  // We need to map the Sheet Name (which is the "safe" name) back to the real Supplier ID and Name.
  var supplierMap = {};
  var suppliersSheet = ss.getSheetByName("Suppliers");
  if (suppliersSheet) {
    var sData = suppliersSheet.getDataRange().getValues();
    // Headers: id, name
    // Assume row 1 is headers.
    if (sData.length > 1) {
       for (var k = 1; k < sData.length; k++) {
         var sRow = sData[k];
         var sId = sRow[0];
         var sName = sRow[1];
         if (sName) {
           var sSafeName = sName.replace(/[:\/\\?*\[\]]/g, "_"); // Same regex as in doPost
           supplierMap[sSafeName] = {
             id: sId,
             name: sName
           };
         }
       }
    }
  }

  // Helper to find column index by header name
  function getColIndex(headers, possibleNames) {
    for (var i = 0; i < headers.length; i++) {
      if (possibleNames.indexOf(headers[i]) > -1) {
        return i;
      }
    }
    return -1;
  }

  // --- Step 2: Iterate through all sheets ---
  for (var i = 0; i < sheets.length; i++) {
    var sheet = sheets[i];
    var sheetName = sheet.getName();
    
    // Skip System Sheets and Income Sheets
    if (sheetName == "All_Expenses_Master" || 
        sheetName == "All_Incomes_Master" || 
        sheetName == "Suppliers" || 
        sheetName == "Customers" || 
        sheetName == "Leads" || 
        sheetName.indexOf("Inc_") === 0) {
      continue;
    }
    
    // Assume it's a Supplier Sheet
    var lastRow = sheet.getLastRow();
    if (lastRow <= 1) continue; 
    
    // Get all data including headers
    var fullData = sheet.getDataRange().getValues();
    var headers = fullData[0];
    var data = fullData.slice(1); // Rows excluding headers
    
    // Map existing columns dynamically
    var idxId = getColIndex(headers, ["מזהה", "id", "ID"]);
    var idxAmount = getColIndex(headers, ["סכום", "amount", "Amount"]);
    var idxDate = getColIndex(headers, ["תאריך", "date", "Date"]);
    var idxCategory = getColIndex(headers, ["קטגוריה", "category"]);
    var idxNotes = getColIndex(headers, ["הערות", "notes"]);
    var idxInvoice = getColIndex(headers, ["מספר_חשבונית", "חשבונית", "invoice"]);
    var idxCreated = getColIndex(headers, ["נוצר_בתאריך", "createdAt"]);
    
    // If essential columns are missing, it might not be a valid expense sheet
    if (idxId === -1 && idxAmount === -1) continue;

    // Resolve Supplier Info
    var supplierInfo = supplierMap[sheetName];
    var realSupplierId = supplierInfo ? supplierInfo.id : ("SUP_" + sheetName);
    var realSupplierName = supplierInfo ? supplierInfo.name : sheetName;

    for (var j = 0; j < data.length; j++) {
      var row = data[j];
      
      // Safety check: ensure row has data
      var amount = (idxAmount > -1) ? row[idxAmount] : "";
      if (amount === "" && (idxId === -1 || row[idxId] === "")) continue;

      var id = (idxId > -1) ? row[idxId] : "";
      var date = (idxDate > -1) ? row[idxDate] : "";
      var category = (idxCategory > -1) ? row[idxCategory] : "";
      var notes = (idxNotes > -1) ? row[idxNotes] : "";
      var invoice = (idxInvoice > -1) ? row[idxInvoice] : "";
      var createdAt = (idxCreated > -1) ? row[idxCreated] : "";
      
      allExpenses.push([
        id, 
        amount, 
        date, 
        realSupplierId,   // Use matched ID
        realSupplierName, // Use matched Name
        category, 
        notes, 
        invoice, 
        createdAt 
      ]);
    }
  }
  
  // Sort by Date (Column 3, index 2) Descending
  allExpenses.sort(function(a, b) {
    var dateA = new Date(a[2]);
    var dateB = new Date(b[2]);
    return dateB - dateA;
  });
  
  if (allExpenses.length > 0) {
    masterSheet.getRange(2, 1, allExpenses.length, 9).setValues(allExpenses);
  }
}
